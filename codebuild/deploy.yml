version: 0.2

phases:
  install:
    commands:
      - echo "starting sbt release versioning"
      - ./codebuild/shell_scripts/create-sbt-creds.sh ${ARTIFACTORY_HOST} ${ARTIFACTORY_API_PW}
      - cd all-spark
      - aws secretsmanager get-secret-value --secret-id spark-datavinci-repo-public-key | jq ."SecretString" | sed 's/"//g' > /root/.ssh/id_rsa.pub
      - private=$(aws secretsmanager get-secret-value --secret-id spark-datavinci-repo-private-key | jq ."SecretString" | sed 's/"//g')
      - echo ${private} > /root/.ssh/id_rsa
      - chmod 700 /root/.ssh
      - chmod 600 /root/.ssh/id_rsa
      - chmod 600 /root/.ssh/id_rsa.pub
      - git checkout ${BRANCH}
      - git branch --set-upstream-to origin/${BRANCH}
      - git branch -u origin/${BRANCH}
      - git config branch.${BRANCH}.remote origin
      - git config branch.${BRANCH}.merge refs/heads/${BRANCH}
      - git remote set-url origin git@github.com:plume-design/spark-datavinci.git
      - git config --global user.email "devops@plumewifi.com"
      - git config --global user.name "machine-plume"
      - sbt 'release with-defaults'
  build:
    commands:
      - echo "starting build"
      - sbt assembly
  post_build:
    commands:
      - echo "build succeeded, sending Jar artifact to ${S3_BUCKET}"
      - cd ..
      - ls all-spark/target/scala-2.11
      - find . -regex './all-spark/target/scala-2.11/analytics.*assembly.*[0-9].jar' -exec cp {} . \;
      - artifact=$(ls | grep analytics*.jar)
      - echo "Configuring AWS datavinci profile for cross account access"
      - aws configure set aws_access_key_id ${ACCESS_KEY}
      - aws configure set aws_secret_access_key ${SECRET_KEY}
      - aws configure set region us-west-2
      - aws configure set output json
      - aws s3 rm s3://${REMOTE_BUCKET}/current-tag/ --recursive
      - aws s3 cp ${artifact} s3://${REMOTE_BUCKET}/current-tag/ --acl bucket-owner-full-control
      - aws s3 cp ${artifact} s3://${REMOTE_BUCKET}/jar-builds/ --acl bucket-owner-full-control
artifacts:
  files: